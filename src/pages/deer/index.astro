---
import Layout from '../../layouts/Layout.astro';
import { getAnimalIncidents, renderMarkdown } from '../../lib/content';

const incidents = getAnimalIncidents();

// Count by animal type (sum of counts, not incidents)
const deerCount = incidents.filter(i => i.animal === 'deer').reduce((sum, i) => sum + i.count, 0);
const raccoonCount = incidents.filter(i => i.animal === 'raccoon').reduce((sum, i) => sum + i.count, 0);
const otherCount = incidents.filter(i => i.animal === 'other').reduce((sum, i) => sum + i.count, 0);
const totalCount = deerCount + raccoonCount + otherCount;

// Group by car
const incidentsByCar = incidents.reduce((acc, incident) => {
  if (!acc[incident.car]) {
    acc[incident.car] = [];
  }
  acc[incident.car].push(incident);
  return acc;
}, {} as Record<string, typeof incidents>);

// Get cars sorted by most recent incident
const carOrder = Object.keys(incidentsByCar).sort((a, b) => {
  const aDate = new Date(incidentsByCar[a][0].date).getTime();
  const bDate = new Date(incidentsByCar[b][0].date).getTime();
  return bDate - aDate;
});

// Render markdown content for each incident
const renderedIncidents = await Promise.all(
  incidents.map(async (incident) => ({
    slug: incident.slug,
    html: await renderMarkdown(incident.content),
  }))
);
const htmlMap = Object.fromEntries(renderedIncidents.map(r => [r.slug, r.html]));

// Animal emoji map
const animalEmoji: Record<string, string> = {
  deer: 'ü¶å',
  raccoon: 'ü¶ù',
  other: 'üêæ',
};
---

<Layout title="Roadkill Counter" description="A running tally of animal-related automotive incidents">
  <div class="mt-16 sm:mt-18">
    <div class="mx-auto max-w-7xl">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">

          <!-- Stats header -->
          <header class="text-center mb-16">
            <h1 class="text-3xl sm:text-4xl font-bold text-zinc-800 dark:text-zinc-100 mb-8">
              Murphy&apos;s Law Counter
            </h1>

            <!-- Animal counts -->
            <div class="flex justify-center gap-8 sm:gap-12 flex-wrap">
              {deerCount > 0 && (
                <div class="text-center">
                  <div class="text-5xl sm:text-7xl font-black text-amber-500 dark:text-amber-400">
                    {deerCount}
                  </div>
                  <div class="text-lg text-zinc-600 dark:text-zinc-400 mt-1">
                    ü¶å Deer
                  </div>
                </div>
              )}
              {raccoonCount > 0 && (
                <div class="text-center">
                  <div class="text-5xl sm:text-7xl font-black text-zinc-500 dark:text-zinc-400">
                    {raccoonCount}
                  </div>
                  <div class="text-lg text-zinc-600 dark:text-zinc-400 mt-1">
                    ü¶ù Raccoons
                  </div>
                </div>
              )}
              {otherCount > 0 && (
                <div class="text-center">
                  <div class="text-5xl sm:text-7xl font-black text-zinc-500 dark:text-zinc-400">
                    {otherCount}
                  </div>
                  <div class="text-lg text-zinc-600 dark:text-zinc-400 mt-1">
                    üêæ other
                  </div>
                </div>
              )}
              {carOrder.length > 0 && (
                <div class="text-center">
                  <div class="text-5xl sm:text-7xl font-black text-red-500 dark:text-red-400">
                    {carOrder.length}
                  </div>
                  <div class="text-lg text-zinc-600 dark:text-zinc-400 mt-1">
                    üöó {carOrder.length === 1 ? 'Car' : 'Cars'} Deep
                  </div>
                </div>
              )}
            </div>

            {totalCount === 0 && (
              <div class="text-5xl sm:text-7xl font-black text-green-500 dark:text-green-400">
                0
              </div>
            )}

            <p class="mt-6 text-base text-zinc-600 dark:text-zinc-400 max-w-lg mx-auto">
              A running tally of my encounters with Michigan's wildlife.
            </p>
          </header>

          <!-- Timeline by car -->
          {carOrder.length > 0 ? (
            <div class="space-y-16">
              {carOrder.map((car) => (
                <section>
                  <!-- Car header -->
                  <div class="flex items-center gap-4 mb-8">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-zinc-200 dark:bg-zinc-700 flex items-center justify-center">
                      <svg class="w-6 h-6 text-zinc-600 dark:text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-zinc-800 dark:text-zinc-100">{car}</h2>
                      <p class="text-sm text-zinc-500 dark:text-zinc-400">
                        {incidentsByCar[car].length} incident{incidentsByCar[car].length !== 1 ? 's' : ''}
                      </p>
                    </div>
                  </div>

                  <!-- Timeline -->
                  <div class="relative pl-8 border-l-2 border-zinc-200 dark:border-zinc-700 space-y-12">
                    {incidentsByCar[car].map((incident) => (
                      <article class="relative">
                        <!-- Timeline dot -->
                        <div class="absolute -left-[25px] w-4 h-4 rounded-full bg-amber-400 dark:bg-amber-500 border-4 border-white dark:border-zinc-900"></div>

                        <!-- Date -->
                        <time class="text-sm font-medium text-amber-600 dark:text-amber-400 block mb-2">
                          {new Date(incident.date).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            timeZone: 'UTC'
                          })}
                        </time>

                        <!-- Content -->
                        <div class="bg-zinc-50 dark:bg-zinc-800/50 rounded-2xl p-5 sm:p-6">
                          <div class="flex items-start gap-3 mb-3">
                            <span class="text-2xl" title={incident.animal}>
                              {animalEmoji[incident.animal] || 'üêæ'}{incident.count > 1 && <span class="text-sm align-top">√ó{incident.count}</span>}
                            </span>
                            <div>
                              <h3 class="text-lg font-semibold text-zinc-800 dark:text-zinc-100">
                                {incident.title}
                              </h3>
                              {incident.damage && (
                                <p class="text-sm text-red-600 dark:text-red-400 mt-1">
                                  {incident.damage}
                                </p>
                              )}
                            </div>
                          </div>

                          {incident.content && (
                            <div class="prose prose-sm dark:prose-invert max-w-none text-zinc-600 dark:text-zinc-400 mb-4" set:html={htmlMap[incident.slug]} />
                          )}

                          <!-- Images - scrapbook style -->
                          {incident.images && incident.images.length > 0 && (
                            <div class="flex flex-wrap gap-3 mt-4">
                              {incident.images.map((img: string, idx: number) => (
                                <div
                                  class:list={[
                                    "relative rounded-lg overflow-hidden shadow-md border-4 border-white dark:border-zinc-700",
                                    idx % 3 === 0 ? "rotate-1" : idx % 3 === 1 ? "-rotate-2" : "rotate-2"
                                  ]}
                                  style="max-width: 280px;"
                                >
                                  <img
                                    src={img}
                                    alt={`${incident.title} damage photo`}
                                    class="w-full h-auto object-cover"
                                    loading="lazy"
                                    onerror="this.parentElement.style.display='none'"
                                  />
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </article>
                    ))}
                  </div>
                </section>
              ))}
            </div>
          ) : (
            <div class="text-center py-16">
              <div class="text-6xl mb-4">ü¶å</div>
              <p class="text-zinc-600 dark:text-zinc-400">
                No incidents recorded yet. Let's hope it stays that way...
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>
